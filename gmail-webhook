const Imap = require('imap');
const { simpleParser } = require('mailparser');
const axios = require('axios');

require('dotenv').config();

const imap = new Imap({
  user: process.env.GMAIL_USER,
  password: process.env.GMAIL_PASS,
  host: 'imap.gmail.com',
  port: 993,
  tls: true
});

function openInbox(cb) {
  imap.openBox('INBOX', false, cb);
}

imap.once('ready', function () {
  openInbox((err, box) => {
    if (err) throw err;
    console.log(`üì© Monitoring Gmail for new emails...`);

    imap.on('mail', () => {
      const fetch = imap.seq.fetch(`${box.messages.total}:*`, { bodies: '' });
      fetch.on('message', (msg) => {
        msg.on('body', (stream) => {
          simpleParser(stream, async (err, parsed) => {
            if (err) throw err;

            const emailData = {
              subject: parsed.subject || 'Nezn√°my predmet',
              from: parsed.from.text || 'Nezn√°my odosielateƒæ',
              text: parsed.text || '',
              html: parsed.html || ''
            };

            console.log("üì• Prijat√Ω email:", emailData);

            // ‚úÖ Handler na spracovanie e-mailu
            const parsedOrder = processOrderEmail(emailData);

            if (parsedOrder) {
              console.log("‚úÖ Platn√° objedn√°vka, posielam na webhook:", parsedOrder);
              await axios.post('https://airkicks.eu/webhook', parsedOrder);
            } else {
              console.log("‚ùå E-mail nie je objedn√°vka, ignorujem.");
            }
          });
        });
      });
    });
  });
});

imap.once('error', (err) => {
  console.log('‚ùå Chyba IMAP:', err);
});

imap.once('end', () => {
  console.log('üì§ IMAP spojenie zatvoren√©');
});

imap.connect();

/**
 * Handler na spracovanie e-mailov z Shoptetu
 * @param {Object} emailData - D√°ta z e-mailu
 * @returns {Object|null} - Spracovan√° objedn√°vka alebo null
 */
function processOrderEmail(emailData) {
  if (!emailData.subject.includes("Objedn√°vka")) {
    return null; // ‚ùå Ak e-mail nie je objedn√°vka, ignorujeme ho
  }

  // üì¶ Pokus o extrakciu √∫dajov
  const orderIdMatch = emailData.text.match(/K√≥d objedn√°vky:\s?(\d+)/);
  const productMatch = emailData.text.match(/(Sneaker Shields)/);
  const sizeMatch = emailData.text.match(/Veƒækos≈• tenisky:\s?([\d-]+)/);
  const priceMatch = emailData.text.match(/Cena za m.1:\s?([\d,]+) ‚Ç¨/);

  if (!orderIdMatch || !productMatch || !sizeMatch || !priceMatch) {
    return null; // ‚ùå Ak sa nepodarilo extrahova≈• √∫daje, ignorujeme e-mail
  }

  return {
    order_id: orderIdMatch[1].trim(),
    product_name: productMatch[1].trim(),
    size: sizeMatch[1].trim(),
    price: parseFloat(priceMatch[1].replace(',', '.').trim()),
    email_subject: emailData.subject,
    email_from: emailData.from
  };
}
